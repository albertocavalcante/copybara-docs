---
title: Authentication
description: Configuring authentication for Copybara
---

import { Aside, Tabs, TabItem } from "@astrojs/starlight/components";

Copybara needs authentication to read from origins and write to destinations.

## Authentication Methods

| Method                          | Use Case              | Security |
| ------------------------------- | --------------------- | -------- |
| Personal Access Token (Classic) | Quick setup           | Medium   |
| Fine-Grained Token              | Scoped access         | High     |
| SSH Key                         | Traditional Git auth  | Medium   |
| Deploy Key                      | Single repo write     | High     |
| GitHub App                      | Enterprise automation | High     |

## Personal Access Token (Classic)

<Tabs>
<TabItem label="Setup">

1. Go to GitHub **Settings** → **Developer settings** → **Personal access tokens** → **Tokens (classic)**
2. Click "Generate new token (classic)"
3. Select scopes:
   - `repo` (full repository access)
   - `workflow` (if modifying workflows)
4. Generate and copy the token

See [GitHub's token documentation](https://docs.github.com/en/authentication/keeping-your-account-and-data-secure/managing-your-personal-access-tokens) for details.

</TabItem>
<TabItem label="Usage">

Configure Git to use your token via the credential helper:

```bash
# Enable credential storage
git config --global credential.helper store

# Git will prompt for credentials on first use
# Username: x-access-token
# Password: <your-token>
```

In GitHub Actions, use the built-in `GITHUB_TOKEN` or configure credentials via environment:

```yaml
- name: Configure Git
  env:
    GH_TOKEN: ${{ secrets.PAT }}
  run: |
    git config --global credential.helper '!f() { echo "username=x-access-token"; echo "password=${GH_TOKEN}"; }; f'
```

</TabItem>
</Tabs>

## Fine-Grained Token (Recommended)

More secure than classic tokens with repository-scoped access:

<Tabs>
<TabItem label="Setup">

1. Go to GitHub **Settings** → **Developer settings** → **Personal access tokens** → **Fine-grained tokens**
2. Click "Generate new token"
3. Set expiration
4. Select repository access: "Only select repositories"
5. Choose the destination repository
6. Set permissions:
   - **Contents**: Read and write
   - **Pull requests**: Read and write
   - **Metadata**: Read

</TabItem>
<TabItem label="Usage">

Same credential helper approach as classic tokens:

```bash
git config --global credential.helper store
# Git prompts for credentials on first authenticated operation
```

</TabItem>
</Tabs>

<Aside type="tip">
  Fine-grained tokens can be scoped to specific repositories, limiting blast
  radius if compromised.
</Aside>

## SSH Key

Traditional Git authentication using SSH:

<Tabs>
<TabItem label="Setup">

1. Generate SSH key:

   ```bash
   ssh-keygen -t ed25519 -C "copybara@example.com" -f ~/.ssh/copybara_key
   ```

2. Add public key to GitHub:
   - **Settings** → **SSH and GPG keys** → **New SSH key**
   - Or repository **Settings** → **Deploy keys** (for single repo)

See [GitHub's SSH documentation](https://docs.github.com/en/authentication/connecting-to-github-with-ssh) for complete setup.

</TabItem>
<TabItem label="Usage">

```bash
# Add key to SSH agent
eval "$(ssh-agent -s)"
ssh-add ~/.ssh/copybara_key

# Or specify key file directly
GIT_SSH_COMMAND="ssh -i ~/.ssh/copybara_key" java -jar copybara.jar ...
```

In GitHub Actions:

```yaml
- name: Configure SSH
  uses: webfactory/ssh-agent@v0.9.0
  with:
    ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}
```

</TabItem>
</Tabs>

Use SSH URL in config:

```starlark
destination = git.destination(
    url = "git@github.com:org/repo.git",
    push = "main",
)
```

## Deploy Key

SSH key scoped to a single repository:

<Tabs>
<TabItem label="Setup">

1. Generate SSH key:

   ```bash
   ssh-keygen -t ed25519 -C "copybara-deploy" -f ~/.ssh/deploy_key
   ```

2. Add to repository:
   - Repository **Settings** → **Deploy keys**
   - Add deploy key (paste the `.pub` file contents)
   - Enable "Allow write access"

</TabItem>
<TabItem label="Usage">

```yaml
- name: Configure Deploy Key
  uses: webfactory/ssh-agent@v0.9.0
  with:
    ssh-private-key: ${{ secrets.DEPLOY_KEY }}
```

</TabItem>
</Tabs>

<Aside type="note">
  Deploy keys only work for one repository. Use a GitHub App or PAT for
  multi-repo workflows.
</Aside>

## GitHub App

Best for enterprise and multi-repo automation:

<Tabs>
<TabItem label="Setup">

1. Create GitHub App:

   - Organization **Settings** → **Developer settings** → **GitHub Apps**
   - New GitHub App
   - Set permissions:
     - Contents: Read and write
     - Pull requests: Read and write
     - Metadata: Read
   - Install on required repositories

2. Note the App ID and generate a private key

See [GitHub Apps documentation](https://docs.github.com/en/apps/creating-github-apps) for complete setup.

</TabItem>
<TabItem label="Usage">

```yaml
- name: Generate token
  id: app-token
  uses: actions/create-github-app-token@v1
  with:
    app-id: ${{ secrets.APP_ID }}
    private-key: ${{ secrets.APP_PRIVATE_KEY }}
    repositories: destination-repo

- name: Configure Git
  env:
    GH_TOKEN: ${{ steps.app-token.outputs.token }}
  run: |
    git config --global credential.helper '!f() { echo "username=x-access-token"; echo "password=${GH_TOKEN}"; }; f'
```

</TabItem>
</Tabs>

## GitLab Authentication

For GitLab repositories, create a personal access token:

1. Go to **User Settings** → **Access Tokens**
2. Create token with scopes: `read_repository`, `write_repository`
3. Use `oauth2` as username with your token as password

See [GitLab token documentation](https://docs.gitlab.com/ee/user/profile/personal_access_tokens.html).

## Gerrit Authentication

For Gerrit destinations, generate an HTTP password:

1. Go to Gerrit **Settings** → **HTTP Credentials**
2. Generate new password
3. Configure Git credential helper with your username and HTTP password

## Security Best Practices

1. **Use fine-grained tokens** when possible
2. **Limit scope** to only required repositories
3. **Set expiration** on tokens (30-90 days recommended)
4. **Rotate regularly** (especially after team changes)
5. **Use CI/CD secrets** - never commit credentials to repositories
6. **Audit access** periodically via GitHub/GitLab audit logs
7. **Use GitHub Apps** for production automation

<Aside type="caution">
  Never commit tokens or credentials to your repository. Always use CI/CD secret
  management (GitHub Secrets, GitLab CI Variables, etc.).
</Aside>

## Troubleshooting

### "Authentication failed"

- Verify token hasn't expired
- Check token has required scopes (`repo` for full access)
- Test with: `git ls-remote <repository-url>`
- For fine-grained tokens, verify the repository is selected

### "Permission denied (publickey)"

- Verify SSH key is added to ssh-agent: `ssh-add -l`
- Test SSH connection: `ssh -T git@github.com`
- Check key is added to GitHub/GitLab

### "Host key verification failed"

Add the host to known hosts:

```bash
ssh-keyscan github.com >> ~/.ssh/known_hosts
ssh-keyscan gitlab.com >> ~/.ssh/known_hosts
```

### Token Scope Reference

| Operation             | Required GitHub Scope |
| --------------------- | --------------------- |
| Read public repo      | (none)                |
| Read private repo     | `repo`                |
| Push to repo          | `repo`                |
| Create pull request   | `repo`                |
| Modify GitHub Actions | `repo`, `workflow`    |

## Next Steps

- [GitHub Actions setup](/cicd/github-actions/)
- [Automation patterns](/cicd/automation/)
